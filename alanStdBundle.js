for(var t,e=[],r=0;r<256;++r)e.push((r+256).toString(16).slice(1));var i=new Uint8Array(16);function n(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(i)}var a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function s(t,r,i){if(a.randomUUID&&!r&&!t)return a.randomUUID();var s=(t=t||{}).random||(t.rng||n)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,r){i=i||0;for(var u=0;u<16;++u)r[i+u]=s[u];return r}return function(t,r=0){return(e[t[r+0]]+e[t[r+1]]+e[t[r+2]]+e[t[r+3]]+"-"+e[t[r+4]]+e[t[r+5]]+"-"+e[t[r+6]]+e[t[r+7]]+"-"+e[t[r+8]]+e[t[r+9]]+"-"+e[t[r+10]]+e[t[r+11]]+e[t[r+12]]+e[t[r+13]]+e[t[r+14]]+e[t[r+15]]).toLowerCase()}(s)}class u{constructor(t){this.message=t}}function o(t){return Number.isNaN(t)?new u("Not a Number"):t}function l(t,e,r){return t?.val??t?e():r()}class h{constructor(t){this.map=t??{}}static valToId(t){let e=t.toString();return globalThis.GPUBuffer&&(t instanceof globalThis.GPUBuffer?e=t.label:t.rawBuffer instanceof globalThis.GPUBuffer&&(e=t.rawBuffer.label)),e}store(t){let e=h.valToId(t);this.map[e]=t}has(t){let e=h.valToId(t);return new D(this.map.hasOwnProperty(e))}len(){return new y(Object.keys(this.map).length)}array(){return[...Object.values(this.map)]}makeMapWith(t,e){let r={};for(let i of t)r[i]=this.has(i).val?this.map[i]:e.map[i];return r}union(t){let e={};for(let t of Object.keys(this.map))e[t]=!0;for(let r of Object.keys(t.map))e[r]=!0;let r=this.makeMapWith(Object.keys(e),t);return new h(r)}intersect(t){let e={};for(let r of Object.keys(this.map))t.has(r).val&&(e[r]=!0);let r=this.makeMapWith(Object.keys(e),t);return new h(r)}difference(t){let e={};for(let r of Object.keys(this.map))t.has(r).val||(e[r]=!0);let r=this.makeMapWith(Object.keys(e),t);return new h(r)}symmetricDifference(t){let e={};for(let r of Object.keys(this.map))t.has(r).val||(e[r]=!0);for(let r of Object.keys(t.map))this.has(r).val||(e[r]=!0);let r=this.makeMapWith(Object.keys(e),t);return new h(r)}product(t){let e=new h;for(let r of Object.keys(this.map))for(let i of Object.keys(t.map))e.store([this.map[r],t.map[i]]);return e}}function c(t){return t instanceof Array?t.map(c):t instanceof h?t.union(new h):t instanceof Map?new Map([...t.entries()].map((t=>[c(t[0]),c(t[1])]))):t.build instanceof Function?t.build(t.val):t instanceof Object?Object.fromEntries([...Object.entries(t)].map((t=>[t[0],c(t[1])]))):structuredClone(t)}class f{constructor(t,e,r,i,n){if(64===e){let e=BigInt(t);this.val=e>n?n:e<i?i:e}else this.val=Math.max(i,Math.min(n,Number(t)));this.bits=e,this.size=r,this.lower=i,this.upper=n}wrap(t){for(t=64===this.bits?BigInt(t):Number(t);t>this.upper;)t-=this.size;for(;t<this.lower;)t+=this.size;return t}wrappingAdd(t){return this.build(this.val+t.val)}wrappingSub(t){return this.build(this.val-t.val)}wrappingMul(t){return this.build(this.val*t.val)}wrappingDiv(t){return 64===this.bits?this.build(this.val/t.val):this.build(Math.floor(this.val/t.val))}wrappingMod(t){return this.build(this.val%t.val)}wrappingPow(t){return 64===this.bits?this.build(this.val**t.val):this.build(Math.floor(this.val**t.val))}not(){return this.build(~this.val)}wrappingShl(t){if(this.bits>=32){let e=(this.val<0?BigInt(this.val)+BigInt(this.size):BigInt(this.val))<<BigInt(t);return this.build(e)}return this.build((this.val<0?this.val+this.size:this.val)<<t.val)}wrappingShr(t){if(this.bits>=32){let e=(this.val<0?BigInt(this.val)+BigInt(this.size):BigInt(this.val))>>BigInt(t);return this.build(e)}return this.build((this.val<0?this.val+this.size:this.val)>>t.val)}rotateLeft(t){if(this.bits>=32){let e=this.val<0?BigInt(this.val)+BigInt(this.size):BigInt(this.val),r=BigInt(t.val);for(;r>BigInt(this.bits-1);)r-=BigInt(this.bits);if(0n==r)return this.build(this.val);let i=BigInt(this.size)-1n&BigInt(this.size)-1n<<BigInt(this.bits)-r,n=e&i,a=e&(BigInt(this.size)-1n&(BigInt(this.size)-1n^i));return this.build((n>>BigInt(this.bits)-r)+(a<<r))}{let e=this.val<0?this.val+this.size:this.val,r=t.val;for(;r>this.bits-1;)r-=this.bits;if(0==r)return this.build(this.val);let i=this.size-1&this.size-1<<this.bits-r,n=e&i,a=e&(this.size-1&(this.size-1^i));return this.build((n>>this.bits-r)+(a<<r))}}rotateRight(t){if(this.bits>=32){let e=this.val<0?BigInt(this.val)+BigInt(this.size):BigInt(this.val),r=BigInt(t.val);for(;r>BigInt(this.bits-1);)r-=BigInt(this.bits);if(0n==r)return this.build(this.val);let i=BigInt(this.size)-1n&BigInt(this.size)-1n<<r,n=e&(BigInt(this.size)-1n&(BigInt(this.size)-1n^i)),a=e&i;return this.build((n<<BigInt(this.bits)-r)+(a>>r))}{let e=this.val<0?this.val+this.size:this.val,r=t.val;for(;r>this.bits-1;)r-=this.bits;if(0==r)return this.build(this.val);let i=this.size-1&this.size-1<<r,n=e&(this.size-1&(this.size-1^i)),a=e&i;return this.build((n<<this.bits-r)+(a>>r))}}clz(){const t=this.val<(64==this.bits?0n:0)?BigInt(this.val+this.size):BigInt(this.val);if(0n==t)return this.build(this.bits);let e=BigInt(this.bits/2),r=0,i=0,n=Math.log2(this.bits);do{i++,t<2n**e?(r=BigInt(this.bits)-e,e-=BigInt(Math.round(this.bits/2**(i+1)))):e+=BigInt(Math.round(this.bits/2**(i+1)))}while(i<n);return this.build(r)}ctz(){let t=this.val<(64==this.bits?0n:0)?BigInt(this.val+this.size):BigInt(this.val);if(0n==t)return this.build(this.bits);let e=0;for(let r=0;r<this.bits&&t%2n==0n;r++)e++,t>>=1n;return this.build(e)}ones(){let t=this.val<(64==this.bits?0n:0)?BigInt(this.val+this.size):BigInt(this.val),e=0;for(let r=0;r<this.bits;r++)e+=Number(t%2n),t>>=1n;return this.build(e)}reverseBits(){let t=this.val<(64==this.bits?0n:0)?BigInt(this.val+this.size):BigInt(this.val),e=0n;for(let r=0;r<this.bits;r++)e+=(1n&t)<<BigInt(this.bits-r-1),t>>=1n;return this.build(this.upper<e?e-BigInt(this.size):e)}valueOf(){return this.val}toString(){return this.val.toString()}}class d extends f{static ArrayKind=Int32Array;constructor(t){super(t,8,256,-128,127)}build(t){return new d(this.wrap(t))}}class p extends f{static ArrayKind=Uint32Array;constructor(t){super(t,8,256,0,255)}build(t){return new p(this.wrap(t))}}class v extends f{static ArrayKind=Int32Array;constructor(t){super(t,16,65536,-32768,32767)}build(t){return new v(this.wrap(t))}}class w extends f{static ArrayKind=Uint32Array;constructor(t){super(t,16,65536,0,65535)}build(t){return new w(this.wrap(t))}}class b extends f{static ArrayKind=Int32Array;constructor(t){super(t,32,4294967296,-2147483648,2147483647)}build(t){return new b(this.wrap(t))}}class g extends f{static ArrayKind=Uint32Array;constructor(t){super(t,32,4294967296,0,4294967295)}build(t){return new g(this.wrap(t))}}class y extends f{static ArrayKind=Int32Array;constructor(t){super(t,64,18446744073709551616n,-9223372036854775808n,9223372036854775807n)}build(t){return new y(this.wrap(t))}}class m extends f{static ArrayKind=Uint32Array;constructor(t){super(t,64,18446744073709551616n,0n,18446744073709551615n)}build(t){return new m(this.wrap(t))}}class B{constructor(t,e){this.val=t,this.bits=e}roundTiesEven(){let t=Math.floor(this.val);return this.val-t==.5?this.build(t%2==0?t:t+1):this.build(Math.round(this.val))}valueOf(){return this.val}toString(){return this.val.toString()}}class A extends B{static ArrayKind=Float32Array;constructor(t){super(Number(t),32)}build(t){return new A(t)}}class I extends B{static ArrayKind=Float32Array;constructor(t){super(Number(t),64)}build(t){return new I(t)}}function z(t){const e=new ArrayBuffer(1),r=new Int8Array(e),i=new Uint8Array(e);return r[0]=t.val,new p(i[0])}function P(t){const e=new ArrayBuffer(2),r=new Int16Array(e),i=new Uint16Array(e);return r[0]=t.val,new w(i[0])}function U(t){const e=new ArrayBuffer(4),r=new Int32Array(e),i=new Uint32Array(e);return r[0]=t.val,new g(i[0])}function S(t){const e=new ArrayBuffer(4),r=new Int32Array(e),i=new Float32Array(e);return r[0]=t.val,new A(i[0])}function k(t){const e=new ArrayBuffer(8),r=new BigInt64Array(e),i=new BigUint64Array(e);return r[0]=t.val,new m(i[0])}function O(t){const e=new ArrayBuffer(8),r=new BigInt64Array(e),i=new Float64Array(e);return r[0]=t.val,new I(i[0])}function M(t){const e=new ArrayBuffer(1),r=new Uint8Array(e),i=new Int8Array(e);return r[0]=t.val,new d(i[0])}function x(t){const e=new ArrayBuffer(2),r=new Uint16Array(e),i=new Int16Array(e);return r[0]=t.val,new v(i[0])}function C(t){const e=new ArrayBuffer(4),r=new Uint32Array(e),i=new Int32Array(e);return r[0]=t.val,new b(i[0])}function G(t){const e=new ArrayBuffer(4),r=new Uint32Array(e),i=new Float32Array(e);return r[0]=t.val,new A(i[0])}function T(t){const e=new ArrayBuffer(8),r=new BigUint64Array(e),i=new BigInt64Array(e);return r[0]=t.val,new y(i[0])}function W(t){const e=new ArrayBuffer(8),r=new BigUint64Array(e),i=new Float64Array(e);return r[0]=t.val,new I(i[0])}function q(t){const e=new ArrayBuffer(4),r=new Float32Array(e),i=new Int32Array(e);return r[0]=t.val,new b(i[0])}function E(t){const e=new ArrayBuffer(4),r=new Float32Array(e),i=new Uint32Array(e);return r[0]=t.val,new g(i[0])}function _(t){const e=new ArrayBuffer(8),r=new Float64Array(e),i=new BigInt64Array(e);return r[0]=t.val,new y(i[0])}function j(t){const e=new ArrayBuffer(8),r=new Float64Array(e),i=new BigUint64Array(e);return r[0]=t.val,new m(i[0])}class D{constructor(t){this.val=Boolean(t),this.ArrayKind=Int8Array}valueOf(){return this.val}toString(){return this.val.toString()}}class F{constructor(t){this.val=String(t)}valueOf(){return this.val}toString(){return this.val.toString()}}function K(t,e,r){if(e.val<0||e.val>t.length)return new u(`Provided index ${e.val} is beyond the bounds of the array`);if(r.val<0||r.val>t.length)return new u(`Provided index ${r.val} is beyond the bounds of the array`);let i=t[e.val];t[e.val]=t[r.val],t[r.val]=i}async function R(t,e){if(t.length<2)return;let r=Math.floor(t.length/2),i=[...t],n=i.splice(0,r);await R(n,e),await R(i,e);let a=await async function(t,e,r){let i=[];for(;t.length&&e.length;)await r(t[0],e[0])<0?i.push(t.shift()):i.push(e.shift());return[...i,...t,...e]}(n,i,e);for(let e=0;e<a.length;e++)t[e]=a[e]}function V(t,e){let r=t[0].constructor;return[new r(t[1].val*e[2].val-t[2].val*e[1].val),new r(t[2].val*e[0].val-t[0].val*e[2].val),new r(t[0].val*e[1].val-t[1].val*e[0].val)]}class Y{constructor(t,e,r){this.adapter=t,this.device=e,this.queue=r}static async list(){let t=[],e=await(navigator?.gpu?.requestAdapter({powerPreference:"high-performance"})),r=await(navigator?.gpu?.requestAdapter({powerPreference:"low-power"})),i=await(navigator?.gpu?.requestAdapter());return e&&t.push(e),r&&t.push(r),i&&t.push(i),t}static async init(t){let e=[];for(let r of t){let t=r.features,i=r.limits,n=r.info,a=await r.requestDevice({label:`${n.device} on ${n.architecture}`,requiredFeatures:t,requiredLimits:i});e.push(new Y(r,a,a.queue))}return e}}let N=null;async function L(){if(null===N&&(N=await Y.init(await Y.list())),N.length>0)return N[0];throw new u("This program requires a GPU but there are no WebGPU-compliant GPUs on this machine")}async function $(t,e){let r=await L(),i=await r.device.createBuffer({mappedAtCreation:!0,size:e.length*(e[0]?.bits??32)/8,usage:t,label:`buffer_${s().replaceAll("-","_")}`}),n=i.getMappedRange(),a=new(e[0].constructor.ArrayKind??Int32Array)(n);for(let t=0;t<e.length;t++)a[t]=e[t].valueOf();return i.unmap(),i.ValType=e[0].constructor,i}async function X(t,e,r){let i=await L(),n=await i.device.createBuffer({size:e.valueOf()*(r?.bits??32)/8,usage:t,label:`buffer_${s().replaceAll("-","_")}`});return n.ValKind=r,n}function H(){return GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}function J(){return GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC}function Q(){return GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}function Z(t){return new y(t.size/((t?.ValKind?.bits??32)/8))}function tt(t){return new F(t.label)}class et{constructor(t,e,r,i){this.source=t,this.entrypoint=i??"main",this.buffers=e,this.workgroupSizes=r,this.module=void 0,this.computePipeline=void 0}}async function rt(t){let e=await L();t.module||(t.module=e.device.createShaderModule({code:t.source}));let r=t.module;t.computePipeline||(t.computePipeline=e.device.createComputePipeline({layout:"auto",compute:{entryPoint:t.entryPoint,module:r}}));let i=t.computePipeline,n=e.device.createCommandEncoder(),a=n.beginComputePass();a.setPipeline(i);for(let r=0;r<t.buffers.length;r++){let n=i.getBindGroupLayout(r),s=t.buffers[r],u=[];for(let t=0;t<s.length;t++)u.push({binding:t,resource:{buffer:s[t]}});let o=e.device.createBindGroup({layout:n,entries:u});a.setBindGroup(r,o)}a.dispatchWorkgroups(t.workgroupSizes[0].valueOf(),(t.workgroupSizes[1]??1).valueOf(),(t.workgroupSizes[2]??1).valueOf()),a.end(),e.queue.submit([n.finish()])}async function it(t){let e=await L(),r=e.device.createCommandEncoder();for(let i of t){i.module||(i.module=e.device.createShaderModule({code:i.source}));let t=i.module;i.computePipeline||(i.computePipeline=e.device.createComputePipeline({layout:"auto",compute:{entryPoint:i.entryPoint,module:t}}));let n=i.computePipeline,a=r.beginComputePass();a.setPipeline(n);for(let t=0;t<i.buffers.length;t++){let r=n.getBindGroupLayout(t),s=i.buffers[t],u=[];for(let t=0;t<s.length;t++)u.push({binding:t,resource:{buffer:s[t]}});let o=e.device.createBindGroup({layout:r,entries:u});a.setBindGroup(t,o)}a.dispatchWorkgroups(i.workgroupSizes[0].valueOf(),(i.workgroupSizes[1]??1).valueOf(),(i.workgroupSizes[2]??1).valueOf()),a.end()}e.queue.submit([r.finish()])}async function nt(t,e){let r=await L();await r.queue.onSubmittedWorkDone();let i=await X(H(),t.size/4),n=r.device.createCommandEncoder();n.copyBufferToBuffer(t,0,i,0,t.size),r.queue.submit([n.finish()]),await i.mapAsync(GPUMapMode.READ);let a=i.getMappedRange(0,t.size),s=b,u=Int32Array;/F32/.test(e)?(s=A,u=Float32Array):/U32/.test(e)?(s=g,u=Uint32Array):(s=b,u=Int32Array);let o=new u(a),l=[];for(let t=0;t<o.length;t++)l[t]=new s(o[t]);return i.unmap(),i.destroy(),l}async function at(t,e){if(e.length!=Z(t))return new u("The input array is not the same size as the buffer");let r=await $(J(),e),i=await L(),n=i.device.createCommandEncoder();n.copyBufferToBuffer(r,0,t,0,t.size),i.queue.submit([n.finish()]),r.destroy()}function st(t){return new g(t.canvas.width)}function ut(t){return new g(t.canvas.height)}function ot(t){return new g(t.bufferWidth/4)}function lt(t){return void 0===t.mouseX&&(t.mouseX=new g(0),t.mouseY=new g(0)),t.mouseX}function ht(t){return void 0===t.mouseY&&(t.mouseX=new g(0),t.mouseY=new g(0)),t.mouseY}function ct(t){t.cursorVisible=!0}function ft(t){t.cursorVisible=!1}function dt(t){t.transparent=!0}function pt(t){t.transparent=!1}function vt(t){return E(new A((performance.now()-t.start)/1e3))}function wt(t,e){t.canvas=document.getElementById(e.toString())}function bt(t){return t.context}function gt(t){return t.framebuffer}async function yt(t,e,r){"complete"!==document.readyState&&"loaded"!==document.readyState&&await new Promise((t=>document.addEventListener("DOMContentLoaded",(()=>t()))));let i={canvas:void 0,start:void 0,bufferWidth:void 0,mouseX:void 0,mouseY:void 0,cursorVisible:!0,transparent:!1};if(await t(i),i.start=performance.now(),!i.canvas){let t=document.createElement("canvas");t.setAttribute("id","AlanWindow"),document.body.appendChild(t),t.style["z-index"]=9001,t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.width="100%",t.style.height="100%",t.width=window.innerWidth,t.height=window.innerHeight,window.addEventListener("resize",(()=>{t.width=window.innerWidth,t.height=window.innerHeight})),i.canvas=t}i.cursorVisible||(i.canvas.style.cursor="none"),i.canvas.addEventListener("mousemove",(t=>{void 0===i.mouseX&&void 0===i.mouseY||(i.mouseX=new g(t.offsetX),i.mouseY=new g(t.offsetY))}));let n=i.canvas.getContext("webgpu"),a=await navigator.gpu.requestAdapter(),u=await a.requestDevice(),o=u.queue;n.configure({device:u,format:"bgra8unorm",alphaMode:i.transparent?"premultiplied":"opaque",usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,viewFormats:["bgra8unorm"]});let l=await u.createBuffer({size:16,usage:Q(),label:`buffer_${s().replaceAll("-","_")}`});l.ValKind=g;let h=Math.max(1,i.canvas.width),c=Math.max(1,i.canvas.height);i.bufferWidth=4*h%256==0?4*h:4*h+(256-4*h%256);let f=c,d=i.bufferWidth*f,p=await u.createBuffer({size:d,usage:Q(),label:`buffer_${s().replaceAll("-","_")}`});p.ValKind=g;let v=await r({context:l,framebuffer:p}),w=async function(){if(h!==i.canvas.width||c!==i.canvas.height){h=i.canvas.width,c=i.canvas.height,i.bufferWidth=4*h%256==0?4*h:4*h+(256-4*h%256),f=c,d=i.bufferWidth*f;let t=p.label,e=await u.createBuffer({size:d,usage:Q(),label:`buffer_${s().replaceAll("-","_")}`});e.ValKind=g;for(let r of v)for(let i of r.buffers){let r;for(let e=0;e<i.length;e++){if(i[e].label==t){r=e;break}}void 0!==r&&(i[r]=e)}p.destroy(),p=e}let t=l.label,r=n.getCurrentTexture(),a=u.createCommandEncoder(),b=await e(i),y=await u.createBuffer({mappedAtCreation:!0,size:4*b.length,usage:Q(),label:`buffer_${s().replaceAll("-","_")}`}),m=y.getMappedRange(),B=new Uint32Array(m);for(let t=0;t<b.length;t++)B[t]=b[t].valueOf();y.unmap(),y.ValType=g;for(let e of v){void 0===e.module&&(e.module=u.createShaderModule({code:e.source})),void 0===e.computePipeline&&(e.computePipeline=u.createComputePipeline({compute:{module:e.module,entryPoint:e.entryPoint},layout:"auto"}));let r=[],i=a.beginComputePass();i.setPipeline(e.computePipeline);for(let i=0;i<e.buffers.length;i++){let n=e.computePipeline.getBindGroupLayout(i),a=e.buffers[i];for(let e=0;e<a.length;e++)a[e].label===t&&(a[e]=y);let s=[];for(let t=0;t<a.length;t++)s.push({binding:t,resource:{buffer:a[t]}});let o=u.createBindGroup({layout:n,entries:s});r.push(o)}for(let t=0;t<e.buffers.length;t++)i.setBindGroup(t,r[t]);let n=0,s=0;switch(e.workgroupSizes[0].val){case-1:n=h;break;case-2:n=c;break;default:n=e.workgroupSizes[0].val}switch(e.workgroupSizes[1].val){case-1:s=h;break;case-2:s=c;break;default:s=e.workgroupSizes[1].val}let o=e.workgroupSizes[2].val;i.dispatchWorkgroups(n,s,o),i.end()}l.destroy(),l=y,a.copyBufferToTexture({buffer:p,bytesPerRow:i.bufferWidth},{texture:r},[h,c,1]),o.submit([a.finish()]),requestAnimationFrame(w)};requestAnimationFrame(w),await new Promise((t=>{}))}export{u as AlanError,D as Bool,A as F32,I as F64,B as Float,h as FuzzySet,et as GPGPU,Y as GPU,v as I16,b as I32,y as I64,d as I8,f as Int,F as Str,w as U16,g as U32,m as U64,p as U8,tt as bufferid,Z as bufferlen,c as clone,ot as contextBufferWidth,wt as contextCanvas,ft as contextCursorInvisible,ct as contextCursorVisible,ut as contextHeight,lt as contextMouseX,ht as contextMouseY,pt as contextOpaque,vt as contextRuntime,dt as contextTransparent,st as contextWidth,$ as createBufferInit,X as createEmptyBuffer,V as cross,q as f32AsI32,E as f32AsU32,_ as f64AsI64,j as f64AsU64,bt as frameContext,gt as frameFramebuffer,L as gpu,rt as gpuRun,it as gpuRunList,P as i16AsU16,S as i32AsF32,U as i32AsU32,O as i64AsF64,k as i64AsU64,z as i8AsU8,l as ifbool,H as mapReadBufferType,J as mapWriteBufferType,o as nanToError,nt as readBuffer,at as replaceBuffer,yt as runWindow,R as sort,Q as storageBufferType,K as swap,x as u16AsI16,G as u32AsF32,C as u32AsI32,W as u64AsF64,T as u64AsI64,M as u8AsI8,s as uuidv4};
